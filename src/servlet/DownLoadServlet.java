package servlet;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.OutputStream;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.*;
//import com.sun.xml.internal.messaging.saaj.util.ByteOutputStream;

/**
 * Servlet implementation class DownLoadServlet
 */
@WebServlet("/DownLoadServlet")
public class DownLoadServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;

    /**
     * @see HttpServlet#HttpServlet()
     */
    public DownLoadServlet() {
        super();
        // TODO Auto-generated constructor stub
    }

    /**
     * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
     */
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        //得到你要下载的文件名（由前一个页面传过来）
        String fileName = new String
                (request.getParameter("fileName").getBytes("ISO-8859-1"),"UTF-8");
        //得到项目在tomcat 中的更路径
        String realPath = request.getRealPath("/");
        //得到文件在服务器中的路径
        String path = realPath+ "/upload/";//
//				path =request.getParameter("fileName")+"/"+request.getParameter("filePath");
        path += request.getParameter("g_id");
        path +="/"+request.getParameter("fileName");
        //清空response 所有信息
        response.reset();
        //设置IE浏览器内容类型 表示为 下载
        response.setContentType("application/x-download;charset=UTF-8");
        //设置IE浏览器的 头
        response.setHeader("Content-Disposition","attachment;filename="+ fileName);
        //从服务器上 读取文件
        File file=new File(path);    response.setContentLength(Integer.valueOf(((Long)file.length()).toString()));
        System.out.println(file.toString());
        //输入流   读取目标文件
        FileInputStream  fis=new FileInputStream(file);
        int len=-1;
        byte[] data=new byte[1024];
        ByteArrayOutputStream bos=new ByteArrayOutputStream(1024);
        // 文件读到最末尾 返回 -1
        while((len=fis.read(data))!=-1)
        {
            //将服务器中的数据 转换成二进制数组 放入内存中
            bos.write(data,0,len);
        }
        //将 服务器上的文件转换成 二进制数组   OutPutStream 输出流 写入对应文件中
        OutputStream os= response.getOutputStream();
        //从服务器 拿到数据 向客户端进行写入
        os.write(bos.toByteArray());
        //清空内存文件 向客户端写入
        os.flush();
        //关闭输出流
        os.close();
        //关闭输入流
        fis.close();
        response.sendRedirect("GroupInformationServlet?info_type=1&flag=1&g_id="+request.getParameter("g_id"));

    }

    /**
     * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
     */
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // TODO Auto-generated method stub
        doGet(request, response);
    }

}
